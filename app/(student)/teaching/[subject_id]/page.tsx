'use client';

import LessonInfoCard from '@/app/components/lessons/LessonInfoCard';
import StudentInfoCard from '@/app/components/lessons/StudentInfoCard';
import { NotFound } from '@/app/components/NotFound';
import GroupSkeleton from '@/app/components/skeleton/GroupSkeleton';
import useErrorMessage from '@/hooks/useErrorMessage';
import { LayoutContext } from '@/layout/context/layoutcontext';
import { fetchItemsLessons, fetchMainLesson, fetchSubjects } from '@/services/studentMain';
import { lessonType } from '@/types/lessonType';
import Link from 'next/link';
import { useParams } from 'next/navigation';
import { Accordion, AccordionTab, AccordionTabChangeEvent } from 'primereact/accordion';
import { ProgressSpinner } from 'primereact/progressspinner';
import { useContext, useEffect, useState } from 'react';

export default function StudentLesson() {
    // types
    interface subjectType {
        id_curricula: number;
        course_ids: number[];
        streams: number[];
    }

    const { subject_id } = useParams();
    const params = new URLSearchParams();

    const { setMessage } = useContext(LayoutContext);
    const showError = useErrorMessage();

    const [main_id, setMain_id] = useState<predmetType | null>(null);

    const [skeleton, setSkeleton] = useState(false);
    const [hasLessons, setHasLessons] = useState(false);
    const [lessons, setLessons] = useState<Record<number, { semester: { name_kg: string } } | predmetType>>({
        1: { semester: { name_kg: '' } }
    });
    const [courses, setCourses] = useState<
        { id: number; connections: { subject_type: string; id: number; user_id: number | null; id_stream: number }[]; title: string; description: string; user: { last_name: string; name: string; father_name: string }; lessons: lessonType[] }[]
    >([]);
    const [hasThemes, setHasThemes] = useState(false);
    const [activeAccordion, setActiveAccordion] = useState<number>(0);
    const [activeIndex, setActiveIndex] = useState<number | number[]>(0);

    const [activeIndexes, setActiveIndexes] = useState<Record<number, number | null>>({});
    const [accordionIndex, setAccordionIndex] = useState({ index: null });

    // types
    // old mainlesson
    // const handleMainLesson = async (lesson_id: number, stream_id: number) => {
    //     const data = await fetchMainLesson(lesson_id, stream_id);

    //     if (data) {
    //         if (data.length > 0) {
    //             setHasSteps(false);
    //             setMainSteps(data);
    //         } else {
    //             setHasSteps(true);
    //         }
    //     } else {
    //         setHasSteps(true);
    //     }
    // };

    const handleMainLesson = async (lesson_id: number, stream_id: number) => {
        const data = await fetchMainLesson(lesson_id, stream_id);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ null/–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
        if (data && data.length > 0) {
            return data;
        }
        return [];
    };

    // –í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID —É—Ä–æ–∫–∞
    const getLessonIdByCourseAndIndex = (course: any, index: number) => {
        // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ lessonType –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–µ steps: any[]
        return course.lessons[index]?.id;
    };

    const handleTabChange = async (courseId: number, e: any) => {
        // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (–û–ö)
        setActiveIndexes((prev) => ({
            ...prev,
            [courseId]: e.index // e.index - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å —Ç–µ–º—ã (AccordionTab)
        }));
        setAccordionIndex({ index: e.index });

        const course = courses.find((c) => c.id === courseId);

        // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (e.index == null –∏–ª–∏ -1),
        // –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
        if (course && e.index !== null && e.index >= 0) {
            const lessonId = getLessonIdByCourseAndIndex(course, e.index);
            const stream = course.connections[0];

            // 2. –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é handleMainLesson –∏ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (lessonId && stream) {
                // –û–∂–∏–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤

                // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Ä–æ–∫–∞
                setCourses((prevCourses) =>
                    prevCourses.map((c) => {
                        if (c.id === courseId) {
                            return {
                                ...c,
                                lessons: c.lessons.map(
                                    (l) => (l.id === lessonId ? { ...l, isLoadingSteps: true } : l) // üí° –í–ö–õ–Æ–ß–ê–ï–ú
                                )
                            };
                        }
                        return c;
                    })
                );

                const newSteps = await handleMainLesson(lessonId, stream.id_stream);
                console.warn(newSteps);
                if (newSteps) {
                    // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ courses: –¥–æ–±–∞–≤–ª—è–µ–º steps –∫ –Ω—É–∂–Ω–æ–º—É —É—Ä–æ–∫—É
                    setCourses((prevCourses) =>
                        prevCourses.map((c) => {
                            // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π –∫—É—Ä—Å
                            if (c.id === courseId) {
                                return {
                                    ...c,
                                    lessons: c.lessons.map((l) =>
                                        // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π —É—Ä–æ–∫ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —à–∞–≥–∏
                                        l.id === lessonId ? { ...l, steps: newSteps, isLoadingSteps: false } : l
                                    )
                                };
                            }
                            return c;
                        })
                    );
                }
            }
        }
    };

    // fetch lessons
    const handleFetchLessons = async () => {
        setSkeleton(true);
        const data = await fetchItemsLessons();
        if (data) {
            // –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
            setLessons(data);
            setHasLessons(false);
            setSkeleton(false);
        } else {
            setHasLessons(true);
            setMessage({
                state: true,
                value: { severity: 'error', summary: '–û—à–∏–±–∫–∞!', detail: '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ' }
            });
            if (data?.response?.status) {
                showError(data.response.status);
            }
            setSkeleton(false);
        }
    };

    // –ó–∞–ø—Ä–æ—Å –∫—É—Ä—Å–∞, —Ç–∏–ø–∞ —É—Ä–æ–∫–æ–≤ (–ª–∫,–ª–±)
    const handleFetchSubject = async (subject: subjectType) => {
        params.append('id_curricula', String(subject.id_curricula));
        subject.streams.forEach((i) => params.append('streams[]', String(i)));
        subject.course_ids.forEach((i) => params.append('course_ids[]', String(i)));
        const data = await fetchSubjects(params);

        setSkeleton(true);

        if (data) {
            setCourses(data);
            setHasThemes(false);
            setSkeleton(false);
        } else {
            setHasThemes(true);
            setMessage({
                state: true,
                value: { severity: 'error', summary: '–û—à–∏–±–∫–∞!', detail: '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ' }
            });
            if (data?.response?.status) {
                showError(data.response.status);
            }
            setSkeleton(false);
        }
    };

    // –ù–ê–•–û–î–ò–ú –ü–û –ò–î –ö–†–£–ö–õ–ê –ù–£–ñ–ù–´–ô –≠–õ–ï–ú–ï–ù–¢ –ú–ê–°–°–ò–í–ê –ò –ü–†–ò–°–í–ê–ò–í–ê–ï–ú –í main_id –û–ë–™–ï–ö–¢

    // –ü—Ä–æ—Å–∏–º –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–∑ –Ω–∏—Ö
    useEffect(() => {
        handleFetchLessons();
    }, []);

    // –ò–∑ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ–ª—É—á–∞—é –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Ä—Å –≤ main_id
    useEffect(() => {
        const lessonArray = Object.values(lessons);
        // console.log(lessonArray)
        let search_id: predmetType | null = null;
        if (lessonArray && Array.isArray(lessonArray)) {
            for (let i = 0; i < lessonArray.length; i++) {
                const lessonItemArray = Object.values(lessonArray[i]);
                // console.log(lessonItemArray);

                search_id = lessonItemArray.find((item: any) => item.id_curricula == subject_id);
                if (search_id && search_id != null) {
                    break;
                }
            }
            if (search_id) {
                setMain_id(search_id);
            }
        }
    }, [lessons]);

    // –ù–ê–•–û–î–ò–ú –ü–û –ò–î –ö–†–£–ö–õ–ê –ù–£–ñ–ù–´–ô –≠–õ–ï–ú–ï–ù–¢ –ú–ê–°–°–ò–í–ê –ò –ü–†–ò–°–í–ê–ò–í–ê–ï–ú –í main_id –û–ë–™–ï–ö–¢

    useEffect(() => {
        if (main_id && main_id != null) {
            const forSubject: subjectType = { id_curricula: main_id?.id_curricula, course_ids: main_id?.course_ids, streams: main_id?.streams.map((i: { id: number }) => i.id) };
            handleFetchSubject(forSubject);
        }
    }, [main_id]);

    return (
        <div className="main-bg">
            <h1 className="text-xl shadow-[0_2px_1px_0px_rgba(0,0,0,0.1)]">–°–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤</h1>

            {skeleton ? (
                <div className="w-full">
                    <GroupSkeleton count={1} size={{ width: '100%', height: '10rem' }} />
                </div>
            ) : hasThemes ? (
                <NotFound titleMessage="–î–∞–Ω–Ω—ã–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã" />
            ) : (
                courses.map((course) => {
                    return (
                        <div key={course.id} className="flex flex-col gap-4 shadow-sm rounded my-4 py-2 px-1">
                            <div className="flex flex-col gap-2">
                                <h3 className="m-0  text-md break-words">
                                    <span className="text-[var(--mainColor)]">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞:</span> {course?.title}
                                </h3>
                                <h3 className="m-0 text-md ">
                                    <span className="text-[var(--mainColor)]">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</span> {course?.user.last_name} {course?.user.name}
                                </h3>
                                {course?.connections[0]?.subject_type && (
                                    <h3 className="m-0 text-md ">
                                        <span className="text-[var(--mainColor)]">–¢–∏–ø –æ–±—É—á–µ–Ω–∏—è:</span> {course?.connections[0]?.subject_type === '–õ–∫' ? '–õ–µ–∫—Ü–∏—è' : course?.connections[0]?.subject_type === '–õ–±' ? '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è' : ''}
                                    </h3>
                                )}
                            </div>
                            <div>
                                <Accordion key={`${course.id}`} activeIndex={activeIndexes[course.id]} onTabChange={(e) => handleTabChange(course.id, e)} multiple={false} expandIcon="" collapseIcon="">
                                    {course.lessons.map((lesson) => {
                                        const contentPresence = lesson?.steps?.filter((content) => content.content && content?.type?.name !== 'forum');
                                        // console.warn(newLesson);
                                        const sortedSteps = contentPresence?.sort((a, b) => {
                                            const isAForum = a?.type?.name === 'forum';
                                            const isBForum = b?.type?.name === 'forum';

                                            if (isAForum && !isBForum) {
                                                return 1; // 'a' (—Ñ–æ—Ä—É–º) –∏–¥–µ—Ç –ø–æ—Å–ª–µ 'b'
                                            }
                                            if (!isAForum && isBForum) {
                                                return -1; // 'b' (—Ñ–æ—Ä—É–º) –∏–¥–µ—Ç –ø–æ—Å–ª–µ 'a'
                                            }
                                            return 0; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
                                        });

                                        return (
                                            <AccordionTab header={'–¢–µ–º–∞: ' + lesson.title} key={lesson.id} className="w-full p-accordion" style={{ width: '100%', backgroundColor: 'white' }}>
                                                <div className="flex flex-col gap-2">
                                                    {/* –ò—Å–ø–æ–ª—å–∑—É–µ–º lesson.steps, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω –≤ handleTabChange */}
                                                    {lesson?.isLoadingSteps ? (
                                                        <ProgressSpinner style={{ width: '50px', height: '50px' }} />
                                                    ) : sortedSteps && sortedSteps?.length > 0 ? (
                                                        sortedSteps.map(
                                                            (item: { id: number; chills: boolean; type: { name: string; logo: string }; content: { title: string; description: string; url: string; document: string; document_path: string } }, idx) => {
                                                                if (item.content == null || item.type?.name === 'forum') {
                                                                    return null;
                                                                }

                                                                return (
                                                                    <div key={item.id} className={`${idx > 0 ? 'my-border-top' : ''}`}>
                                                                        <StudentInfoCard
                                                                            type={item.type.name}
                                                                            icon={item.type.logo}
                                                                            title={item.content?.title}
                                                                            description={item.content?.description || ''}
                                                                            documentUrl={{ document: item.content?.document, document_path: item.content?.document_path }}
                                                                            link={item.content?.url}
                                                                            stepId={item.id}
                                                                            streams={course}
                                                                            lesson={lesson.id}
                                                                            subjectId={subject_id}
                                                                            chills={item?.chills}
                                                                            fetchProp={() => handleTabChange(course.id, accordionIndex)}
                                                                        />
                                                                    </div>
                                                                );
                                                            }
                                                        )
                                                    ) : (
                                                        <p className="text-center text-sm">–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</p>
                                                    )}
                                                </div>
                                            </AccordionTab>
                                        );
                                    })}
                                </Accordion>
                            </div>
                        </div>
                    );
                })
            )}
        </div>
    );
}
